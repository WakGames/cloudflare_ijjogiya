<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WAKTAVERSE Games CDN Test</title>

    <link rel="stylesheet" href="./assets/css/tailwind.css">
    <link rel="stylesheet" href="./assets/css/style.css">
  </head>
  <body>
    <div class="flex flex-col items-center justify-center gap-8 h-screen bg-gray-100 dark:bg-zinc-900">
        <img src="./assets/img/logo.webp" alt="WAKTAVERSE Games" width="200">

        <div id="prepare" class="flex flex-col items-center justify-center gap-8 mb:w">
            <div class="flex flex-col items-center justify-center">
                <p class="text-xl font-bold text-gray-600 dark:text-gray-400">WAKTAVERSE Games CDN Test</p>
            </div>

            <div class="flex flex-col items-center justify-center">
                <button class="px-4 py-2 text-white bg-blue-500 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-50">
                    100MB 측정 시작하기 &#xf045;
                </button>
            </div>
        </div>

        <div id="doing"></div>

        <!-- 결과값 데이터 넣을 textbox -->
        <textarea id="result" class="hidden text-gray-900 bg-gray-100 dark:text-gray-100 dark:bg-zinc-900 text-sm w-[550px] mb:w-full h-[230px]" readonly></textarea>
    </div>

    <template id="testing">
        <div class="progress">
            <div class="progress-bar" role="progressbar"></div>
        </div>

        <div class="description">
          <span class="start">측정 중...</span>
          <span class="complete">측정 완료</span>
          <span class="error">측정 실패</span>
        </div>
    </template>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"></script>
    
    <script src="./assets/js/toast.js"></script>
    <script src="./assets/js/loading.js"></script>
    
    <script>
      document.querySelector('button').addEventListener('click', () => {
        document.querySelector('#prepare').classList.add('hidden')
        
        document.querySelector('#doing').append(
            document.querySelector('#testing').content.cloneNode(true)
        )

        document.querySelector('.description .start').style.opacity = 1
        document.querySelector('.description .complete').style.opacity = 0

        startTest()
      })

      document.querySelector('#result').addEventListener('click', () => {
        copyToClipboard(document.querySelector('#result').value)
        toast('복사되었습니다.')
      })

      function round(num) {
        var m = Number((Math.abs(num) * 10).toPrecision(15));
        return Math.round(m) / 10 * Math.sign(num);
      }

      function copyToClipboard(val) {
        var t = document.createElement('textarea')
        document.body.appendChild(t)

        t.value = val
        t.select()

        document.execCommand('copy')
        document.body.removeChild(t)
      }

      async function startTest() {
        try {
          toast('측정을 시작합니다.')

          // 1. TRACE 얻기
          const { data: trace } = await axios.get('https://game-assets.waktaverse.games/cdn-cgi/trace')
          
          let traceAsObject = {}
          trace.split('\n').forEach(line => {
              const [key, value] = line.split('=')
              traceAsObject[key] = value
          })

          // 2. 1000MB 파일 다운로드 + progress
          let speed = 0
          let speedHistory = []
          let highestSpeed = 0

          const startTime = new Date().getTime()

          const download = await axios('https://game-assets.waktaverse.games/test_files/vultr.com.100MB.bin', {
              onDownloadProgress: progressEvent => {
                let percentCompleted = Math.round(
                  (progressEvent.loaded * 100) / progressEvent.total
                )

                speed = progressEvent.loaded / (new Date().getTime() - startTime)
                speedHistory.push(speed)
                highestSpeed = Math.max(speed, highestSpeed)

                loading(percentCompleted, false)
              }
          })

          document.querySelector('.description .start').style.opacity = 0
          document.querySelector('.description .complete').style.opacity = 1

          // 3. 결과 출력
          const averageSpeed = speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length
          
          document.querySelector('#result').innerHTML = `
              # 기본 정보
              접속 국가 : ${traceAsObject['loc'].toUpperCase()}
              평균치 : ${round(averageSpeed / 1000)}mb/s
              최대치 : ${round(highestSpeed / 1000)}mb/s
              
              # 특수 정보
              Cache : ${download.headers['cf-cache-status'].toUpperCase()}
              PoP : ${traceAsObject['colo'].toUpperCase()}
              WARP : ${traceAsObject['warp'].toUpperCase()}
          `
          document.querySelector('#result').classList.remove('hidden')
          toast('측정이 완료되었습니다.', 'success')
        } catch (e) {
          loading(100, true)
          document.querySelector('.description .start').style.opacity = 0
          document.querySelector('.description .complete').style.opacity = 0
          document.querySelector('.description .error').style.opacity = 1

          toast(e.toString(), 'error')
          console.error(e)
        }
      }
    </script>
  </body>
</html>
